@inject NavigationManager NavigationManager
@inject SessionStorageService SessionStorage
@inject HttpClient HttpClient
@using BlazorStandAlone.Components
@page "/admin"

<PageTitle>Admin</PageTitle>

<h1>Admin Dashboard</h1>

<Popup @ref="popupRef" Title="Success" Message="@PopupMessage"></Popup>

<div class="admin-container">
    <div class="box">
        <div class="box-header">Amount of Users: @userNumber</div>
        <div class="search-section">
            <input @bind="userId" placeholder="Enter User ID" />
            <button @onclick="GetUserById">Search</button>
            <button @onclick="AddUser">Add User</button>
        </div>
        <div class="box-content">
            @if (SearchUser && CurrentUser != null)
            {
                <div class="info-box"><strong>User ID:</strong> @CurrentUser.Id</div>
                <div class="info-box"><strong>Username:</strong> @CurrentUser.Username</div>
                <div class="info-box"><strong>User Email:</strong> @CurrentUser.Email</div>
                <div class="info-box"><strong>User PhoneNumber:</strong> @CurrentUser.PhoneNumber</div>
                <div class="info-box"><strong>User Role:</strong> @CurrentUser.Role</div>
                <div class="info-box"><strong>Created at:</strong> @CurrentUser.CreatedAt</div>
                <div class="user-tickets">
                    <h3>User's Tickets</h3>
                    @foreach (var ticket in CurrentUser.Tickets!)
                    {
                        <div>
                            <div>
                                <strong>Ticket ID:</strong> @ticket.Id
                                <br />
                                <strong>Title:</strong> @ticket.Title
                            </div>
                            <div><button @onclick="() => DeleteTicket(ticket.Id)">Delete</button></div>
                        </div>
                    }
                </div>
                <button @onclick="() => EditUser(CurrentUser)">Edit</button>
                <button @onclick="DeleteUser">Delete</button>
                <button @onclick="ClearUser">Clear</button>
            }
            @if (UserFormVisible)
            {
                <UserForm UserModel="CurrentUser"
                IsUserEditMode="@IsUserEditMode"
                OnSave="SaveUser"
                OnCancel="HideUserForm" />
            }
        </div>
    </div>

    <div class="box">
        <div class="box-header">Amount of Tickets: @ticketNumber</div>
        <div class="search-section">
            <input @bind="ticketId" placeholder="Enter Ticket ID" />
            <button @onclick="GetTicketById">Search</button>
            <button @onclick="AddTicket">Add Ticket</button>
        </div>
        <div class="box-content">
            @if (SearchTicket && CurrentTicket != null)
            {
                <div class="info-box"><strong>Ticket ID:</strong> @CurrentTicket.Id</div>
                <div class="info-box"><strong>Ticket UserID:</strong> @CurrentTicket.UserId</div>
                <div class="info-box"><strong>Ticket EventID:</strong> @CurrentTicket.EventId</div>
                <div class="info-box"><strong>Ticket Price:</strong> @CurrentTicket.Price</div>
                <div class="info-box"><strong>Seat:</strong> @CurrentTicket.Seat</div>
                <button @onclick="() => DeleteTicket(CurrentTicket.Id)">Delete</button>
                <button @onclick="ClearTicket">Clear</button>
            }
            @if (TicketFormVisible)
            {
                <TicketForm TicketModel="CurrentTicket"
                OnSave="SaveTicket"
                OnCancel="HideTicketForm" />
            }
        </div>
    </div>

    <div class="box">
        <div class="box-header">Amount of Events: @eventNumber</div>
        <div class="search-section">
            <input @bind="eventId" placeholder="Enter Event ID" />
            <button @onclick="GetEventById">Search</button>
            <button @onclick="AddEvent">Add Event</button>
        </div>
        <div class="box-content">
            @if (SearchEvent && CurrentEvent != null)
            {
                <div class="info-box"><strong>Event ID:</strong> @CurrentEvent.Id</div>
                <div class="info-box"><strong>Event name:</strong> @CurrentEvent.Name</div>
                <div class="info-box"><strong>City:</strong> @CurrentEvent.City</div>
                <div class="info-box"><strong>Address:</strong> @CurrentEvent.Address</div>
                <div class="info-box"><strong>AccessType:</strong> @CurrentEvent.AccessType</div>
                <div class="info-box"><strong>Start Time:</strong> @CurrentEvent.StartTime</div>
                <div class="info-box"><strong>End Time:</strong> @CurrentEvent.EndTime</div>
                <div class="info-box"><strong>Designated seats:</strong> @CurrentEvent.HasSeat</div>
                <div class="info-box"><strong>Image path:</strong> @CurrentEvent.ImagePath</div>
                <div class="info-box"><strong>Max tickets:</strong> @CurrentEvent.TicketsMax</div>
                <div class="info-box"><strong>Tickets sold:</strong> @CurrentEvent.TicketsSold</div>
                <button @onclick="() => EditEvent(CurrentEvent)">Edit</button>
                <button @onclick="DeleteEvent">Delete</button>
                <button @onclick="ClearEvent">Clear</button>
            }
            @if (EventFormVisible)
            {
                <EventForm EventModel="CurrentEvent"
                IsEventEditMode="@IsEventEditMode"
                OnSave="SaveEvent"
                OnCancel="HideEventForm" />
            }
        </div>
    </div>
</div>

@code {
    //pagewide
    private LoginDto? user;
    private Popup? popupRef;
    private string PopupMessage = String.Empty;
    private bool development = true;

    //events
    public List<EventDto> events { get; set; } = new();
    public int eventNumber { get; set; }
    public int eventId { get; set; }
    private bool EventFormVisible = false;
    private bool IsEventEditMode = false;
    private bool SearchEvent = false;
    public EventDto? CurrentEvent { get; set; } = null;

    //users
    public List<UserDto> users { get; set; } = new();
    public int userNumber { get; set; }
    public int userId { get; set; }
    private bool UserFormVisible = false;
    private bool IsUserEditMode = false;
    private bool SearchUser = false;
    public UserDto? CurrentUser { get; set; } = null;

    //tickets
    public List<TicketDto> tickets { get; set; } = new();
    public int ticketNumber { get; set; }
    public int ticketId { get; set; }
    private bool TicketFormVisible = false;
    private bool SearchTicket = false;
    public TicketDto? CurrentTicket { get; set; } = null;

    protected override async Task OnInitializedAsync()
    {
        if (development)
        {
            user = new LoginDto() { Username = "admin", Role = UserRole.Admin };
        }
        else
        {
            user = await SessionStorage.GetItemAsync<LoginDto>("user");
        }

        if (user == null)
        {
            NavigationManager.NavigateTo("/login");
        }
        else if (user.Role != UserRole.Admin)
        {
            NavigationManager.NavigateTo("/");
        }

        await PopulateLists();
    }

    private async Task PopulateLists()
    {
        await GetEventsAsync();
        await GetTicketsAsync();
        await GetUsersAsync();
    }


    //events
    private async Task GetEventsAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync("api/event/get");
            if (response.IsSuccessStatusCode)
            {
                events = await response.Content.ReadFromJsonAsync<List<EventDto>>() ?? new();
                eventNumber = events.Count;
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Error fetching events: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception while fetching events: {ex.Message}");
        }
    }

    private void GetEventById()
    {
        HideEventForm();
        CurrentEvent = events.Where(e => e.Id == eventId).FirstOrDefault();
        if (CurrentEvent == null)
        {
            Console.WriteLine("event was not found");
        }
        else
        {
            SearchEvent = true;
        }
    }

    private void EditEvent(EventDto ev)
    {
        CurrentEvent = new EventDto
            {
                Id = ev.Id,
                Name = ev.Name,
                Description = ev.Description,
                City = ev.City,
                Address = ev.Address,
                AccessType = ev.AccessType,
                StartTime = ev.StartTime,
                EndTime = ev.EndTime,
                HasSeat = ev.HasSeat,
                ImagePath = ev.ImagePath,
                TicketsMax = ev.TicketsMax,
                TicketsSold = ev.TicketsSold
            };
        IsEventEditMode = true;
        EventFormVisible = true;
        SearchEvent = false;
    }

    private void HideEventForm() => EventFormVisible = false;

    private async void SaveEvent(EventDto ev)
    {
        if (IsEventEditMode)
        {
            await UpdateEvent(ev);
        }
        else
        {
            await CreateEvent(ev);
        }
        HideEventForm();
        StateHasChanged();
    }

    private void AddEvent()
    {
        ClearEvent();
        CurrentEvent = new EventDto() { Name = null!, City = null!, Description = null!, Address = null!, StartTime = DateTime.Now, EndTime = DateTime.Now.AddHours(1), ImagePath = "hehe" };
        IsEventEditMode = false;
        EventFormVisible = true;
    }

    private async Task CreateEvent(EventDto ev)
    {
        var response = await HttpClient.PostAsJsonAsync("api/event/create", ev);
        if (response.IsSuccessStatusCode)
        {
            await GetEventsAsync();
            ClearEvent();
            PopupMessage = "Event created successfully.";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.ReasonPhrase}");
        }
    }

    private async Task UpdateEvent(EventDto ev)
    {
        var response = await HttpClient.PutAsJsonAsync($"api/event/update/{ev.Id}", ev);
        if (response.IsSuccessStatusCode)
        {
            await GetEventsAsync();
            ClearEvent();
            PopupMessage = "Event updated succesfully!";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.StatusCode}");
        }
    }

    private async Task DeleteEvent()
    {
        if (CurrentEvent == null)
        {
            Console.WriteLine("No event selected, can not delete");
            return;
        }
        var response = await HttpClient.DeleteAsync($"api/event/delete/{CurrentEvent.Id}");
        if (response.IsSuccessStatusCode)
        {
            await GetEventsAsync();
            ClearEvent();
            PopupMessage = "Event deleted successfully";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.StatusCode}");
        }
    }

    private void ClearEvent()
    {
        SearchEvent = false;
        CurrentEvent = null;
    }

    //users
    private async Task GetUsersAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync("api/user/get");
            if (response.IsSuccessStatusCode)
            {
                users = await response.Content.ReadFromJsonAsync<List<UserDto>>() ?? new();
                userNumber = users.Count;
                foreach (var user in users)
                {
                    user.Tickets = GetUserTickets(user.Id);
                }
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Error fetching users: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception while fetching users: {ex.Message}");
        }
    }

    private List<TicketDto> GetUserTickets(int userId)
    {

        List<TicketDto> list = tickets.Where(t => t.UserId == userId).ToList();
        Console.WriteLine(list.Count);
        return list;
    }

    private void GetUserById()
    {
        HideUserForm();
        CurrentUser = users.Where(u => u.Id == userId).FirstOrDefault();
        if (CurrentUser == null)
        {
            Console.WriteLine("user was not found");
        }
        else
        {
            SearchUser = true;
        }
    }

    private void EditUser(UserDto user)
    {
        CurrentUser = new UserDto
            {
                Id = user.Id,
                Username = user.Username,
                Email = user.Email,
                PhoneNumber = user.PhoneNumber,
                Role = user.Role,
                Tickets = user.Tickets
            };
        IsUserEditMode = true;
        UserFormVisible = true;
        SearchUser = false;
    }

    private void HideUserForm() => UserFormVisible = false;

    private async void SaveUser(UserDto user)
    {
        if (IsUserEditMode)
        {
            await UpdateUser(user);
        }
        else
        {
            await CreateUser(user);
        }
        HideUserForm();
        StateHasChanged();
    }

    private void AddUser()
    {
        ClearUser();
        CurrentUser = new UserDto() { Username = null!, Email = null!, PhoneNumber = null, Role = UserRole.User, CreatedAt = DateTime.Now };
        IsUserEditMode = false;
        UserFormVisible = true;

    }

    private async Task CreateUser(UserDto user)
    {
        var newUser = new RegisterUserDto(user.Username, user.Email, user.PhoneNumber, user.Role);

        var response = await HttpClient.PostAsJsonAsync("api/user/create", newUser);
        if (response.IsSuccessStatusCode)
        {
            UserFormVisible = false;
            await GetUsersAsync();
            ClearUser();
            PopupMessage = "User created successfully.";
            popupRef?.Show();

        }
        else
        {
            Console.WriteLine($"error: {response.ReasonPhrase}");
        }
    }

    private async Task UpdateUser(UserDto user)
    {
        var newUser = new RegisterUserDto(user.Username, user.Email, user.PhoneNumber, user.Role);

        var response = await HttpClient.PutAsJsonAsync($"api/user/update/{user.Id}", user);
        if (response.IsSuccessStatusCode)
        {
            await GetUsersAsync();
            ClearUser();
            PopupMessage = "User updated successfully!";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.StatusCode}");
        }
    }

    private async Task DeleteUser()
    {
        if (CurrentUser == null)
        {
            Console.WriteLine("No user selected, can not delete");
            return;
        }
        var response = await HttpClient.DeleteAsync($"api/user/delete/{CurrentUser.Id}");
        if (response.IsSuccessStatusCode)
        {
            await GetUsersAsync();
            ClearUser();
            PopupMessage = "User deleted successfully";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.StatusCode}");
        }
    }

    private void ClearUser()
    {
        SearchUser = false;
        CurrentUser = null;
    }

    //tickets
    private async Task GetTicketsAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync("api/ticket/get");
            if (response.IsSuccessStatusCode)
            {
                tickets = await response.Content.ReadFromJsonAsync<List<TicketDto>>() ?? new();
                ticketNumber = tickets.Count;
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"Error fetching tickets: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception while fetching tickets: {ex.Message}");
        }
    }

    private void GetTicketById()
    {
        HideTicketForm();
        CurrentTicket = tickets.Where(t => t.Id == ticketId).FirstOrDefault();
        if (CurrentTicket == null)
        {
            Console.WriteLine("ticket was not found");
        }
        else
        {
            SearchTicket = true;
        }
    }


    private void HideTicketForm() => TicketFormVisible = false;

    private async void SaveTicket(TicketDto ticket)
    {
        await CreateTicket(ticket);
        HideTicketForm();
    }

    private void AddTicket()
    {
        ClearTicket();
        CurrentTicket = new TicketDto() { UserId = 0, EventId = 0, Price = 0, Seat = null };
        TicketFormVisible = true;
    }

    private async Task CreateTicket(TicketDto ticket)
    {
        var response = await HttpClient.PostAsJsonAsync("api/ticket/create", ticket);
        if (response.IsSuccessStatusCode)
        {
            await GetTicketsAsync();
            ClearTicket();
            PopupMessage = "Ticket created successfully.";
            popupRef?.Show();
        }
        else
        {
            Console.WriteLine($"error: {response.ReasonPhrase}");
        }
    }

    private async Task DeleteTicket(int ticketId)
    {
        var response = await HttpClient.DeleteAsync($"api/ticket/delete/{ticketId}");
        if (response.IsSuccessStatusCode)
        {
            await GetTicketsAsync();
            ClearTicket();
            PopupMessage = "Ticket deleted successfully";
            popupRef?.Show();

            if (CurrentUser != null)
            {
                await GetUsersAsync();
                CurrentUser = users.FirstOrDefault(u => u.Id == CurrentUser.Id);
                if (CurrentUser != null)
                {
                    CurrentUser.Tickets = GetUserTickets(CurrentUser.Id);
                }
            }
        }
        else
        {
            Console.WriteLine($"error: {response.StatusCode}");
        }
    }

    private void ClearTicket()
    {
        SearchTicket = false;
        CurrentTicket = null;
    }
}

