@page "/"
@using BlazorStandAlone.Models
@using BlazorStandAlone.Components
@inject SessionStorageService SessionStorage
@inject NavigationManager NavigationManager
@inject HttpClient HttpClient
@inject IJSRuntime JS

<PageTitle>Östgöta Event</PageTitle>

<section class="landing-page">
    <video autoplay muted loop playsinline class="background-video">
        <source src="movies/ostgota-event-3.mp4" type="video/mp4">
    </video>
    <div class="landing-page-icon-wrapper">
        <a href="#event-section">
            <i id="landing-page-arrow" class="fa-solid fa-arrow-down"></i>
        </a>
    </div>
</section>

@*
dunno kanske todo  
<CostumerSupport></CostumerSupport> 
*@

<section id="event-section" class="event-section">
    <header class="event-section-header">
        <h2>Kommande Event</h2>
        <div class="event-input-box">
   
   <input type="text" id="event-search" 
       @bind="searchEvent" 
       @bind:event="oninput" 
       @onkeypress="HandleSearchKeyPress" 
       placeholder="Sök efter namn, stad, datum">
   <button class="dropbtn" @onclick="FilterEvents">Sök</button>

@* bind:event to make sure searchfield updates when typing
   onkeypress update searchfield when pressing enter  
 *@

                <button class="dropbtn">sortera</button>
        </div> 
    </header> 

    <div class="event-container">
        @foreach(var ev in EventPages){
            <div class="event-card">
  
                <img class="event-img" src="@ev.ImagePath">  
                 
                <div class="event-card-info">
                    <h3>@ev.Name</h3>
                    <p class="event-description">@ev.Description</p>
                    <p>@ev.TicketsSold</p>
                    <p>@ev.StartTime - @ev.EndTime</p>      
                    <p>@ev.Address, @ev.City
                    <a href="#" class="map-icon"><i class="fas fa-location-dot"></i></a>
                    </p>      
                </div> 

                <div class="event-card-buttons">                
                <p class="event-time">@ev.StartTime.ToString("MMM dd", new System.Globalization.CultureInfo("sv-SV"))</p>
                    <div class="event-card-button-container">
                        <button>Visa mer info</button>
                        <button>Boka</button>
                    </div>
                </div>
            </div>
        }

        <div class="pagination-buttons">
            <button @onclick="PreviousPage" disabled="@IsPreviousDisabled">Föregående</button>
            <span>Sida @CurrentPage av @TotalPages</span>
            <button @onclick="NextPage" disabled="@IsNextDisabled">Nästa</button>  
        </div>

    </div>    
</section>


@* JS to the rescue - WHY WOULD YOU EVER SAY THAT!?*@
<script> 
    function scrollToEventSection() {
        document.getElementById('event-section').scrollIntoView();
    }
</script> 

@code {

    //PAGINATION
    public int CurrentPage { get; set; } = 1;
    public int PageSize { get; set; } = 5;

    // making sure there's always atleast one page
    public int TotalPages => Math.Max(1, (int)Math.Ceiling((double)FilteredEvents.Count / PageSize));
   
    // skip and take to get the next 5 events 
    public List<EventDto> EventPages => FilteredEvents.Skip((CurrentPage - 1) * PageSize).Take(PageSize).ToList(); 
    public List<EventDto> events { get; set; } = new();
    
    // bools for the onclick 
    public bool IsNextDisabled => CurrentPage == TotalPages;
    public bool IsPreviousDisabled => CurrentPage == 1;

    public async Task NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            await JS.InvokeVoidAsync("scrollToEventSection");
        }
    }

    public async Task PreviousPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            await JS.InvokeVoidAsync("scrollToEventSection");
        }
    }

    // GET EVENTS

    public string searchEvent { get; set; } = "";
    public List<EventDto> FilteredEvents { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await GetEventsAsync();
        FilteredEvents = new List<EventDto>(events);
    }

    private async Task GetEventsAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync("api/event/get");
            if (response.IsSuccessStatusCode)
            {
                events = await response.Content.ReadFromJsonAsync<List<EventDto>>() ?? new();
                FilteredEvents = new List<EventDto>(events);
                StateHasChanged();
            }
            else
            { 
                Console.WriteLine($"Error fetching events: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception while fetching events: {ex.Message}");
        }
    }

    // filter logic
    private void FilterEvents()
    {
        if (!string.IsNullOrWhiteSpace(searchEvent))
        {
            string searchLower = searchEvent.ToLower();

            FilteredEvents = events.Where(e =>
                e.Name.ToLower().Contains(searchLower) ||      
                e.City.ToLower().Contains(searchLower) ||      
                e.Address.ToLower().Contains(searchLower) ||   
                e.Description.ToLower().Contains(searchLower) || 
                e.StartTime.ToString("yyyy-MM-dd").Contains(searchLower) ||
                e.StartTime.ToString("dd-MM").Contains(searchLower) ||      
                e.StartTime.ToString("MMMM", new System.Globalization.CultureInfo("sv-SE")).ToLower().Contains(searchLower)
            ).ToList();
           CurrentPage = 1; 
        }
        else
        {
            FilteredEvents = new List<EventDto>(events);
        }

        StateHasChanged();
    }

    private void HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            FilterEvents();
        }
    }

    // Login logic
    private LoginDto? user;

    protected async Task OnIntializedAsync()
    {
        var result = await SessionStorage.GetItemAsync<User>("user");

        if (result != null)
        {
            user = new LoginDto() { Username = result.Username, Role = result.Role };
        }
        else
        {
            NavigationManager.NavigateTo("/login");
        }
    }
}
